#!/bin/bash
# ==============================================================================
#  GENTOO-UPDATE: An update notifier & applier for Gentoo Linux
#  Based on arch-update by Antiz96do i
#  https://github.com/Antiz96/arch-update
# ==============================================================================
set -eu

VERSION="3.17.4"
PROG="gentoo-update"

# Color codes
BOLD='\033[1m'
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
NC='\033[0m'

# Privilege escalation options (in order of preference)
declare -a SUDO_CMDS=(run0 sudo-rs doas sudo)
SUDO_CMD=""

# Privilege escalation method for non-interactive use
PRIV_ESCALATION_METHOD="systemd-run"

# Configuration file
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
CONFIG_FILE="$CONFIG_DIR/$PROG/$PROG.conf"
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}"
LAST_CHECK_FILE="$CACHE_DIR/$PROG/last-check"
NEXT_CHECK_FILE="$CACHE_DIR/$PROG/next-check"

# Check updates count (for tray mode)
UPDATES_COUNT=0
WORLD_UPDATES=0
OVERLAY_UPDATES=0

# Init system detection
INIT_SYSTEM=""

# --- [ HELPER FUNCTIONS ] ---
detect_init_system() {
    if [[ -n "$INIT_SYSTEM" ]]; then
        return
    fi

    if command -v systemctl &>/dev/null && [[ -d /run/systemd/system ]]; then
        INIT_SYSTEM="systemd"
    elif command -v rc-service &>/dev/null && command -v rc-update &>/dev/null; then
        INIT_SYSTEM="openrc"
    else
        # Default to systemd for modern systems
        INIT_SYSTEM="systemd"
    fi
}
print_help() {
    cat << EOF
${BOLD}$PROG - An update notifier & applier for Gentoo Linux${NC}

${BOLD}USAGE:${NC}
  $PROG [OPTIONS]

${BOLD}OPTIONS:${NC}
  -h, --help              Display this help message
  --version               Display the version number
  -c, --check             Check for available updates
  --tray                  Start the systray applet
  --tray --enable         Enable systray applet autostart
  --tray --disable        Disable systray applet autostart
  -s, --services          Check for services requiring restart

${BOLD}EXAMPLES:${NC}
  $PROG                   Interactive update (default)
  $PROG --check           Check updates without applying
  $PROG --tray            Start systray applet
  $PROG --tray --enable   Enable tray autostart
EOF
}

print_version() {
    echo "$PROG v$VERSION"
}

# Detect available sudo/privilege escalation command
detect_priv_escalation() {
    for cmd in "${SUDO_CMDS[@]}"; do
        if command -v "$cmd" &>/dev/null; then
            SUDO_CMD="$cmd"
            return 0
        fi
    done

    echo -e "${RED}Error: No privilege escalation method found (sudo, doas, sudo-rs, run0)${NC}" >&2
    return 1
}

# Elevated command execution
run_elevated() {
    if [[ $EUID -eq 0 ]]; then
        "$@"
    else
        case "$SUDO_CMD" in
            run0) run0 "$@" ;;
            sudo-rs) sudo-rs "$@" ;;
            doas) doas "$@" ;;
            sudo) sudo "$@" ;;
        esac
    fi
}

# --- [ UPDATE CHECKING FUNCTIONS ] ---
check_portage_updates() {
    echo -e "${BLUE}Checking for available package updates...${NC}"

    # Sync portage trees
    run_elevated emaint sync -a

    # Check for available updates in @world
    if WORLD_UPDATES=$(run_elevated emerge -puD --with-bdeps=y @world 2>/dev/null | grep -E '^\[' | wc -l); then
        if [[ $WORLD_UPDATES -gt 0 ]]; then
            UPDATES_COUNT=$((UPDATES_COUNT + WORLD_UPDATES))
            echo -e "${GREEN}✓ $WORLD_UPDATES package(s) available for @world${NC}"
        else
            echo -e "${GREEN}✓ System is up to date${NC}"
        fi
    fi
}

check_news() {
    echo -e "${BLUE}Checking for Gentoo news...${NC}"

    if command -v eselect &>/dev/null && eselect news read new &>/dev/null; then
        echo -e "${YELLOW}⚠ New Gentoo news available${NC}"
    fi
}

check_orphan_packages() {
    echo -e "${BLUE}Checking for orphan packages...${NC}"

    if command -v eix &>/dev/null; then
        ORPHANS=$(eix -c -q --installed-with-use 2>/dev/null | wc -l)
        if [[ $ORPHANS -gt 0 ]]; then
            echo -e "${YELLOW}⚠ $ORPHANS orphan package(s) found${NC}"
            UPDATES_COUNT=$((UPDATES_COUNT + 1))
        fi
    fi
}

check_preserved_rebuild() {
    echo -e "${BLUE}Checking for preserved rebuild packages...${NC}"

    if command -v qlist &>/dev/null; then
        PRESERVED=$(qlist -I @preserved-rebuild 2>/dev/null | wc -l)
        if [[ $PRESERVED -gt 0 ]]; then
            echo -e "${YELLOW}⚠ $PRESERVED package(s) need preserved-rebuild${NC}"
            UPDATES_COUNT=$((UPDATES_COUNT + 1))
        fi
    fi
}

check_distfiles_cache() {
    echo -e "${BLUE}Checking distfiles cache...${NC}"

    if [[ -d /var/cache/distfiles ]]; then
        DISTFILES=$(find /var/cache/distfiles -type f -atime +30 2>/dev/null | wc -l)
        if [[ $DISTFILES -gt 0 ]]; then
            echo -e "${YELLOW}⚠ $DISTFILES old distfile(s) in cache${NC}"
            UPDATES_COUNT=$((UPDATES_COUNT + 1))
        fi
    fi
}

check_config_files() {
    echo -e "${BLUE}Checking for config file updates...${NC}"

    if command -v etc-update &>/dev/null; then
        CONFIG_UPDATES=$(etc-update --list 2>/dev/null | grep -E '^\s+[0-9]+\)' | wc -l)
        if [[ $CONFIG_UPDATES -gt 0 ]]; then
            echo -e "${YELLOW}⚠ $CONFIG_UPDATES config file(s) need updating${NC}"
            UPDATES_COUNT=$((UPDATES_COUNT + 1))
        fi
    fi
}

check_kernel_update() {
    echo -e "${BLUE}Checking for kernel updates...${NC}"

    RUNNING_KERNEL=$(uname -r)
    LATEST_KERNEL=$(ls -1 /lib/modules 2>/dev/null | sort -V | tail -n 1)

    if [[ -n "$LATEST_KERNEL" && "$RUNNING_KERNEL" != "$LATEST_KERNEL" ]]; then
        echo -e "${YELLOW}⚠ Kernel update available: $LATEST_KERNEL (Current: $RUNNING_KERNEL)${NC}"
        UPDATES_COUNT=$((UPDATES_COUNT + 1))
    fi
}

check_services_restart() {
    if [[ "$1" == "skip" ]]; then
        return
    fi

    echo -e "${BLUE}Checking for services requiring restart...${NC}"

    detect_init_system

    if [[ "$INIT_SYSTEM" == "systemd" ]]; then
        if command -v systemctl &>/dev/null; then
            RESTART_SERVICES=$(systemctl list-units --all --state=failed 2>/dev/null | grep -E '^\s' | wc -l)
            if [[ $RESTART_SERVICES -gt 0 ]]; then
                echo -e "${YELLOW}⚠ $RESTART_SERVICES service(s) in failed state${NC}"
                UPDATES_COUNT=$((UPDATES_COUNT + 1))
            fi
        fi
    elif [[ "$INIT_SYSTEM" == "openrc" ]]; then
        if command -v rc-service &>/dev/null; then
            echo -e "${BLUE}ℹ OpenRC detected - you may need to restart services manually${NC}"
            echo -e "${BLUE}ℹ Run: sudo rc-service --list${NC}"
        fi
    fi
}

# --- [ INTERACTIVE UPDATE ] ---
interactive_update() {
    echo -e "${BOLD}Gentoo-Update: Interactive System Maintenance${NC}"
    echo ""

    # Check for news first
    if command -v eselect &>/dev/null; then
        if eselect news read new &>/dev/null; then
            echo -e "${YELLOW}New Gentoo news is available.${NC}"
            echo -ne "${BOLD}Read news now? (y/N): ${NC}"
            read -r -t 10 ans || ans=""
            if [[ "$ans" =~ ^([yY])$ ]]; then
                eselect news read
            fi
        fi
    fi

    # Check for updates
    check_portage_updates
    check_news
    check_orphan_packages
    check_preserved_rebuild
    check_distfiles_cache
    check_config_files
    check_kernel_update
    check_services_restart

    if [[ $UPDATES_COUNT -eq 0 ]]; then
        echo -e "${GREEN}${BOLD}All packages are up to date!${NC}"
        return 0
    fi

    echo ""
    echo -e "${YELLOW}${BOLD}$UPDATES_COUNT update(s) available${NC}"
    echo -ne "${BOLD}Proceed with system update? (y/N): ${NC}"
    read -r ans

    if [[ "$ans" =~ ^([yY])$ ]]; then
        # Perform the actual update
        run_elevated emerge --update --deep --newuse --with-bdeps=y @world
        run_elevated emerge @preserved-rebuild 2>/dev/null || true

        # Handle config files
        if command -v etc-update &>/dev/null; then
            echo -e "${BLUE}Handling config file updates...${NC}"
            run_elevated etc-update --automode -20 2>/dev/null || true
        fi

        # Cleanup
        run_elevated emerge --depclean

        # Check reboot requirement
        RUNNING_KERNEL=$(uname -r)
        LATEST_KERNEL=$(ls -1 /lib/modules 2>/dev/null | sort -V | tail -n 1)

        if [[ "$RUNNING_KERNEL" != "$LATEST_KERNEL" ]]; then
            echo -e "${YELLOW}${BOLD}⚠ Reboot required to boot into new kernel${NC}"
            echo -ne "${BOLD}Reboot now? (y/N): ${NC}"
            read -r reboot_ans
            if [[ "$reboot_ans" =~ ^([yY])$ ]]; then
                run_elevated reboot
            fi
        fi

        echo -e "${GREEN}${BOLD}✓ System update complete!${NC}"
    fi
}

# --- [ SYSTRAY MODE ] ---
enable_tray_autostart() {
    AUTOSTART_DIR="$HOME/.config/autostart"
    mkdir -p "$AUTOSTART_DIR"

    cat > "$AUTOSTART_DIR/$PROG-tray.desktop" << EOF
[Desktop Entry]
Type=Application
Name=Gentoo-Update Systray Applet
Exec=/bin/sh -c "sleep 2 && $PROG --tray"
Icon=system-software-update
Terminal=false
Categories=System;Utility;
EOF

    echo -e "${GREEN}✓ Systray applet autostart enabled${NC}"
}

disable_tray_autostart() {
    AUTOSTART_DIR="$HOME/.config/autostart"
    rm -f "$AUTOSTART_DIR/$PROG-tray.desktop"
    echo -e "${GREEN}✓ Systray applet autostart disabled${NC}"
}

start_tray() {
    # This is a simplified tray implementation
    # In a full implementation, this would use PyQt6/Qt6 like arch-update
    echo -e "${YELLOW}Note: Full systray applet requires PyQt6/Qt6 and additional dependencies${NC}"
    echo -e "${BLUE}Starting in check-only mode...${NC}"

    # Periodic checking (runs in background)
    while true; do
        check_portage_updates
        sleep 3600  # Check every hour
    done
}

# --- [ UPDATE RECORD ] ---
record_update_check() {
    mkdir -p "$CACHE_DIR/$PROG"
    date "+%s" > "$LAST_CHECK_FILE"
    echo $(($(date +%s) + 3600)) > "$NEXT_CHECK_FILE"
}

# --- [ MAIN ] ---
main() {
    # Detect privilege escalation method
    if [[ $EUID -ne 0 ]]; then
        detect_priv_escalation || exit 1
    fi

    case "${1:-}" in
        -h|--help)
            print_help
            ;;
        --version)
            print_version
            ;;
        -c|--check)
            check_portage_updates
            check_news
            check_orphan_packages
            check_preserved_rebuild
            check_distfiles_cache
            check_config_files
            check_kernel_update
            check_services_restart "skip"
            record_update_check
            ;;
        -s|--services)
            check_services_restart
            ;;
        --tray)
            case "${2:-}" in
                --enable)
                    enable_tray_autostart
                    ;;
                --disable)
                    disable_tray_autostart
                    ;;
                *)
                    start_tray
                    ;;
            esac
            ;;
        *)
            interactive_update
            record_update_check
            ;;
    esac
}

main "$@"
